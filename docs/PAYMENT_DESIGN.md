# 決済機能設計書 (Stripe Connect Express)

本書は **Stripe Connect Express** を使用した決済機能の設計詳細を記述します。

## 1. アカウント構造

### プラットフォームアカウント
- **所有者**: ゲームコーチングプラットフォーム (PoCオーナー)
- **役割**: プラットフォーム管理、アプリケーション手数料の徴収、出金管理。
- **責任**:
    - Expressオンボーディングを通じたコーチの接続。
    - 決済の実行 (Destination Charges または Separate Charges and Transfers)。
    - 出金スケジュールの管理 (Expressのデフォルトで十分な場合が多い)。
    - 紛争/返金の対応 (Expressではプラットフォームの責任範囲が広い)。

### 連結アカウント (コーチ)
- **タイプ**: **Express**
- **役割**: 資金を受け取るサービス提供者 (コーチ)。
- **機能**:
    - **オンボーディング**: Stripeがホストするオンボーディングフローへリダイレクト。
    - **ダッシュボード**: 簡易版Expressダッシュボードへのアクセス (売上確認、出金確認、口座情報更新)。
    - **出金**: 銀行口座への自動出金。

## 2. コスト試算 (PoCフェーズ)

日本のStripe Connect Express料金 (2025年12月時点) に基づく試算。

### 試算条件 (月4回取引、月1回出金のシナリオ)
- **アクティブアカウント**: 1名 (コーチ役の開発者自身)
- **取引**: 15,000円 × 4回 = **売上合計 60,000円/月**
- **出金頻度**: 月1回 (コスト削減のため)

### 手数料内訳
1.  **決済手数料 (Stripe)**:
    - 60,000円 の 3.6% = **2,160円**
    - *注: これは決済金額から差し引かれます。*

2.  **Connect Express 費用 (プラットフォーム負担)**:
    - **アクティブアカウント料**: **200円** / 月
    - **出金手数料** (月1回出金と仮定):
        - 出金対象額: 60,000円 - 2,160円 = 57,840円
        - 手数料: (57,840円 * 0.25%) + 250円 = 145円 + 250円 = **395円**
    - **プラットフォーム負担合計**: 200円 + 395円 = **595円 / 月**

*※もし出金を週次（月4回）にすると、出金手数料が約1,145円/月 (286円 × 4回) に増加します。*

## 3. 決済フロー (Destination Charges)

PoCでは **Destination Charges (ダイレクト課金)** を使用します。これはプラットフォームが手数料を徴収する最もシンプルな方法です。

1.  **予約**: 生徒がコーチングセッションをリクエスト。
2.  **Payment Intent作成**: プラットフォームがサーバー側で `PaymentIntent` を作成。
    - `amount`: 合計金額 (例: 3,000円)
    - `currency`: `jpy`
    - `transfer_data[destination]`: コーチの連結アカウントID (`acct_...`)
    - `application_fee_amount`: プラットフォーム手数料 (例: 10% = 300円)
3.  **決済実行**: 生徒が Stripe Payment Element 経由でカード情報を入力。
4.  **完了確認**: 決済完了。
    - 3,000円が生徒に請求される。
    - 300円がプラットフォームアカウントに残る。
    - 2,700円 (からStripe決済手数料を引いた額) がコーチのExpressアカウントへ送金される。

## 4. オンボーディングフロー

1.  **コーチ登録**: コーチがプラットフォームのダッシュボードで「Stripeと連携」をクリック。
2.  **Account Link作成**: サーバーがStripe APIを呼び出し、Account Linkを作成。
3.  **リダイレクト**: コーチはStripeがホストするExpressオンボーディングページへ移動。
4.  **本人確認**: コーチが詳細情報 (電話番号、銀行口座など) を入力。
5.  **帰還**: コーチがプラットフォーム (`/return_url`) へリダイレクトされる。
6.  **完了**: プラットフォームがコーチのステータスを「Active」に更新。

## 5. 出金フロー

- **スケジュール**: 月1回 (PoC要件)。
- **手動出金**: テスト用にAPIから手動トリガーも可能。
- **確認**: コーチはExpressダッシュボード (プラットフォームからリンクを提供) で状況を確認。

## 6. 実装ステップ

1.  **Stripe設定**: StripeダッシュボードでConnectを有効化、Expressのブランディング設定。
2.  **バックエンド**:
    - Account Link作成エンドポイント (オンボーディング用)。
    - Payment Intent作成エンドポイント (決済用)。
    - Webhookハンドラー (`account.updated`, `payment_intent.succeeded` 等の監視)。
3.  **フロントエンド**:
    - コーチ用「Stripe連携」ボタン。
    - 生徒用決済ページ (Stripe Elements)。
    - コーチ用Expressダッシュボードへのリンク。

## 7. 実装詳細とUX

### コーチのオンボーディング
- **方式**: Stripe Hosted Onboarding (Stripeホスト型)。
- **フロー**:
    1. コーチがアプリ内で「収益化を開始」をクリック。
    2. アプリがAPI経由で `account_link` を作成。
    3. コーチはStripeのセキュアなページへリダイレクトされ、個人情報や銀行口座を入力。
    4. 完了後、コーチはアプリへ戻される。
- **メリット**: 本人確認 (KYC) や銀行口座バリデーションの複雑なUIを自作する必要がない。

### コーチダッシュボード (売上・出金)
- **戦略**: ハイブリッド方式。
    - **アプリ内表示 (参照のみ)**: Stripe API (`/v1/balance`, `/v1/payouts`) を使用して、「現在の残高」や「最近の出金」をアプリ内に直接表示し、素早く確認できるようにする。
    - **詳細管理**: 「出金設定を管理」ボタンを用意し、**Stripe Express Dashboard** へリダイレクトさせる。銀行口座や税務情報の更新はここで行う必要がある。

### 生徒の決済体験
- **方式**: **Stripe Payment Element**。
- **UX**:
    - アプリの決済ページ内に直接埋め込む。
    - クレジットカード (および Apple Pay / Google Pay 自動対応) をサポート。
    - 決済時に外部サイトへ遷移することなく完結する。
